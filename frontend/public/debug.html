<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>APIè¿æ¥è¯Šæ–­</title>
    <style>
        body {
            font-family: 'Microsoft YaHei', sans-serif;
            max-width: 800px;
            margin: 50px auto;
            padding: 20px;
            background: #1a1a2e;
            color: #eee;
        }
        h1 { color: #4ade80; }
        .test-section {
            background: #16213e;
            padding: 20px;
            margin: 15px 0;
            border-radius: 8px;
            border: 1px solid #0f3460;
        }
        button {
            background: #4ade80;
            color: #1a1a2e;
            border: none;
            padding: 10px 20px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 14px;
            margin: 5px;
        }
        button:hover { background: #22c55e; }
        button:disabled { background: #666; cursor: not-allowed; }
        .result {
            margin-top: 10px;
            padding: 10px;
            border-radius: 4px;
            font-family: monospace;
            font-size: 12px;
            white-space: pre-wrap;
            word-break: break-all;
        }
        .success { background: #14532d; color: #4ade80; border: 1px solid #22c55e; }
        .error { background: #450a0a; color: #f87171; border: 1px solid #dc2626; }
        .info { background: #1e3a8a; color: #60a5fa; border: 1px solid #3b82f6; }
        .loading { background: #422006; color: #fbbf24; border: 1px solid #f59e0b; }
        .log { background: #0f172a; color: #94a3b8; padding: 15px; border-radius: 4px; max-height: 300px; overflow-y: auto; }
    </style>
</head>
<body>
    <h1>ğŸ”§ APIè¿æ¥è¯Šæ–­å·¥å…·</h1>

    <div class="test-section">
        <h3>ç¬¬ä¸€æ­¥ï¼šæ£€æŸ¥åç«¯æœåŠ¡</h3>
        <button onclick="testBackendHealth()">æµ‹è¯•åç«¯å¥åº·æ£€æŸ¥</button>
        <div id="health-result" class="result"></div>
    </div>

    <div class="test-section">
        <h3>ç¬¬äºŒæ­¥ï¼šæµ‹è¯•CORSé¢„æ£€</h3>
        <button onclick="testCORS()">æµ‹è¯•CORS OPTIONSè¯·æ±‚</button>
        <div id="cors-result" class="result"></div>
    </div>

    <div class="test-section">
        <h3>ç¬¬ä¸‰æ­¥ï¼šæµ‹è¯•å®Œæ•´APIè°ƒç”¨</h3>
        <button onclick="testFullAPI()">æµ‹è¯•æŠ•å§”ä¼šAPI (30-60ç§’)</button>
        <div id="api-result" class="result"></div>
    </div>

    <div class="test-section">
        <h3>ğŸ“‹ å®æ—¶æ—¥å¿—</h3>
        <div id="log" class="log">ç­‰å¾…æµ‹è¯•...</div>
    </div>

    <script>
        const API_BASE = 'http://localhost:8004';
        const logDiv = document.getElementById('log');

        function addLog(message, type = 'info') {
            const time = new Date().toLocaleTimeString();
            const colors = {
                'info': '#94a3b8',
                'success': '#4ade80',
                'error': '#f87171',
                'warning': '#fbbf24'
            };
            logDiv.innerHTML += `<div style="color: ${colors[type] || colors.info}">[${time}] ${message}</div>`;
            logDiv.scrollTop = logDiv.scrollHeight;
        }

        async function testBackendHealth() {
            const resultDiv = document.getElementById('health-result');
            resultDiv.className = 'result loading';
            resultDiv.textContent = 'æ­£åœ¨æµ‹è¯•...';
            addLog('å¼€å§‹æµ‹è¯•åç«¯å¥åº·æ£€æŸ¥...');

            const startTime = Date.now();

            try {
                const response = await fetch(`${API_BASE}/health`, {
                    method: 'GET'
                });

                const elapsed = ((Date.now() - startTime) / 1000).toFixed(2);
                const data = await response.json();

                resultDiv.className = 'result success';
                resultDiv.textContent = `âœ… æˆåŠŸ (${elapsed}s)\nçŠ¶æ€: ${data.status}\nå“åº”æ—¶é—´: ${elapsed}ç§’`;
                addLog(`åç«¯å¥åº·æ£€æŸ¥æˆåŠŸ: ${data.status} (${elapsed}s)`, 'success');
            } catch (error) {
                const elapsed = ((Date.now() - startTime) / 1000).toFixed(2);
                resultDiv.className = 'result error';
                resultDiv.textContent = `âŒ å¤±è´¥ (${elapsed}s)\né”™è¯¯: ${error.message}\n\nè¯·ç¡®ä¿åç«¯æœåŠ¡è¿è¡Œåœ¨ http://localhost:8004`;
                addLog(`åç«¯å¥åº·æ£€æŸ¥å¤±è´¥: ${error.message} (${elapsed}s)`, 'error');
            }
        }

        async function testCORS() {
            const resultDiv = document.getElementById('cors-result');
            resultDiv.className = 'result loading';
            resultDiv.textContent = 'æ­£åœ¨æµ‹è¯•CORS...';
            addLog('å¼€å§‹æµ‹è¯•CORSé¢„æ£€è¯·æ±‚...');

            const startTime = Date.now();

            try {
                const response = await fetch(`${API_BASE}/api/v1/committee/meeting`, {
                    method: 'OPTIONS',
                    headers: {
                        'Origin': window.location.origin,
                        'Access-Control-Request-Method': 'POST',
                        'Access-Control-Request-Headers': 'content-type'
                    }
                });

                const elapsed = ((Date.now() - startTime) / 1000).toFixed(2);

                // æ£€æŸ¥CORSå¤´
                const corsHeaders = {
                    'access-control-allow-origin': response.headers.get('access-control-allow-origin'),
                    'access-control-allow-methods': response.headers.get('access-control-allow-methods'),
                    'access-control-allow-headers': response.headers.get('access-control-allow-headers')
                };

                resultDiv.className = 'result success';
                resultDiv.textContent = `âœ… CORSæ­£å¸¸ (${elapsed}s)\nçŠ¶æ€: ${response.status}\nå…è®¸æ¥æº: ${corsHeaders['access-control-allow-origin']}\nå…è®¸æ–¹æ³•: ${corsHeaders['access-control-allow-methods']}`;
                addLog(`CORSé¢„æ£€æˆåŠŸ: ${response.status} (${elapsed}s)`, 'success');
            } catch (error) {
                const elapsed = ((Date.now() - startTime) / 1000).toFixed(2);
                resultDiv.className = 'result error';
                resultDiv.textContent = `âŒ CORSå¤±è´¥ (${elapsed}s)\né”™è¯¯: ${error.message}`;
                addLog(`CORSé¢„æ£€å¤±è´¥: ${error.message} (${elapsed}s)`, 'error');
            }
        }

        async function testFullAPI() {
            const resultDiv = document.getElementById('api-result');
            resultDiv.className = 'result loading';
            resultDiv.textContent = 'æ­£åœ¨æµ‹è¯•API (è¯·ç­‰å¾…30-60ç§’)...';

            addLog('å¼€å§‹æµ‹è¯•å®Œæ•´APIè°ƒç”¨...');
            addLog('æç¤º: è¿™ä¸ªæµ‹è¯•éœ€è¦30-60ç§’ï¼Œå› ä¸ºåç«¯éœ€è¦è°ƒç”¨3ä¸ªAIæ¨¡å‹', 'warning');

            const startTime = Date.now();
            let checkpoints = [];

            // æ¨¡æ‹Ÿè¿›åº¦æ›´æ–°
            const progressInterval = setInterval(() => {
                const elapsed = ((Date.now() - startTime) / 1000);
                const stage = Math.floor(elapsed / 15);
                const stages = ['è·å–å¸‚åœºæ•°æ®...', 'æ£€ç´¢ç½‘ç»œæƒ…æŠ¥...', 'å¤šå¤´åˆ†æä¸­...', 'ç©ºå¤´åˆ†æä¸­...', 'ç»¼åˆå†³ç­–ä¸­...'];
                if (stage < stages.length) {
                    resultDiv.textContent = `æ­£åœ¨æµ‹è¯•API... (${elapsed.toFixed(0)}s)\nå½“å‰é˜¶æ®µ: ${stages[stage]}`;
                }
            }, 1000);

            try {
                const controller = new AbortController();
                const timeoutId = setTimeout(() => controller.abort(), 180000); // 3åˆ†é’Ÿ

                const response = await fetch(`${API_BASE}/api/v1/committee/meeting`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ symbol: '002353' }),
                    signal: controller.signal
                });

                clearTimeout(timeoutId);
                clearInterval(progressInterval);

                const elapsed = ((Date.now() - startTime) / 1000).toFixed(2);

                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}`);
                }

                const data = await response.json();

                resultDiv.className = 'result success';
                resultDiv.textContent = `âœ… APIè°ƒç”¨æˆåŠŸ (${elapsed}s)\nè‚¡ç¥¨: ${data.stock_name} (${data.symbol})\nå†³ç­–: ${data.analysis.final_decision.final_decision}\nå»ºè®®ä»“ä½: ${data.analysis.final_decision.suggested_position}`;

                addLog(`APIè°ƒç”¨æˆåŠŸ: ${data.analysis.final_decision.final_decision} - ${data.analysis.final_decision.suggested_position} (${elapsed}s)`, 'success');
            } catch (error) {
                clearInterval(progressInterval);
                const elapsed = ((Date.now() - startTime) / 1000).toFixed(2);

                let errorMsg = error.message;
                if (error.name === 'AbortError') {
                    errorMsg = 'è¯·æ±‚è¶…æ—¶ (3åˆ†é’Ÿ)ã€‚APIéœ€è¦30-60ç§’å¤„ç†ï¼Œè¯·ç¡®ä¿ç½‘ç»œç¨³å®šã€‚';
                }

                resultDiv.className = 'result error';
                resultDiv.textContent = `âŒ APIè°ƒç”¨å¤±è´¥ (${elapsed}s)\né”™è¯¯: ${errorMsg}`;

                addLog(`APIè°ƒç”¨å¤±è´¥: ${errorMsg} (${elapsed}s)`, 'error');
            }
        }

        // é¡µé¢åŠ è½½æ—¶è‡ªåŠ¨è¿è¡Œæµ‹è¯•
        window.addEventListener('load', () => {
            addLog('è¯Šæ–­é¡µé¢åŠ è½½å®Œæˆ');
            addLog('å»ºè®®æŒ‰é¡ºåºè¿è¡Œæµ‹è¯•ï¼š1. åç«¯å¥åº·æ£€æŸ¥ â†’ 2. CORSæµ‹è¯• â†’ 3. å®Œæ•´APIæµ‹è¯•');
        });
    </script>
</body>
</html>
